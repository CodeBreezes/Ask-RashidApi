@model IEnumerable<BookingAppAPI.DB.Models.Feedback>

@{
    ViewData["Title"] = "All Feedbacks";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.ActiveTabName = "Feedback";

    var uaeTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Arabian Standard Time");
}

<div class="content px-1">
    <div class="card shadow rounded-3">
        <div class="card-header bg-primary text-white rounded-top-3 d-flex flex-wrap justify-content-between align-items-center">
            <h4 class="mb-0">All Feedbacks</h4>

            <form method="get" asp-action="Index" class="row gx-2 gy-1 align-items-end m-0">
                <!-- Date Filter -->
                <div class="col-auto">
                    <label for="dateFilter" class="form-label text-white mb-0">Filter</label>
                    <select name="dateFilter" id="dateFilter" class="form-select form-select-sm"
                            asp-items="ViewBag.DateFilterOptions">
                        <option value="">All</option>
                    </select>
                </div>

                <!-- Category Filter -->
                <div class="col-auto">
                    <label for="categoryFilter" class="form-label text-white mb-0">Category</label>
                    <select name="category" id="categoryFilter" class="form-select form-select-sm"
                            asp-items="ViewBag.CategoryOptions">
                        <option value="">-- All Categories --</option>
                    </select>
                </div>

                <div class="col-auto">
                    <button type="submit" class="btn btn-light btn-sm mt-3">
                        <i class="bi bi-filter me-1"></i> Apply
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive p-2">
            <table class="table table-hover table-striped table-bordered align-middle mb-0" id="tblFeedback">
                <thead class="table-light text-center">
                    <tr>
                        <th>Sr</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Category</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        // Sort alphabetically by Name
                        var sortedFeedbacks = Model.OrderBy(f => f.Name).ToList();
                        foreach (var f in sortedFeedbacks)
                        {
                            var uaeDate = TimeZoneInfo.ConvertTimeFromUtc(f.CreatedDate, uaeTimeZone);
                            <tr>
                                <td class="text-center"></td> <!-- DataTables will auto-number -->
                                <td>@f.Name</td>
                                <td>@f.Email</td>
                                <td>@f.Category</td>
                                <td>
                                    @(f.Message != null && f.Message.Length > 50 ? f.Message.Substring(0, 50) + "..." : f.Message)
                                </td>
                                <td data-order="@uaeDate.ToString("yyyyMMddHHmmss")">
                                    @uaeDate.ToString("dd MMM yyyy, HH:mm")
                                </td>
                                <td class="text-center">
                                    <a asp-action="FeedbackDetail" asp-route-id="@f.Id" class="text-primary" title="View Details">
                                        <i class="fa fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
            var table = $('#tblFeedback').DataTable({
                "pageLength": 10,
                "ordering": true,
                "order": [[1, "asc"]], // Sort alphabetically by Name
                "columnDefs": [
                    { "orderable": false, "targets": 0 }, // Sr column non-sortable
                    { "type": "num", "targets": 5 }       // Date column numeric for ordering
                ],
                "language": { "search": "🔍 Search feedbacks:" },
                "drawCallback": function (settings) {
                    // Auto-number Sr column
                    var api = this.api();
                    api.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1;
                    });
                }
            });

            // Filters
            $('#categoryFilter').on('change', function () {
                table.column(3).search(this.value).draw();
            });

            $('#dateFilter').on('change', function () {
                table.column(5).search(this.value).draw();
            });
        });
    </script>
}
