@model IEnumerable<BookingAppAPI.DB.Models.Feedback>

@{
    ViewData["Title"] = "All Feedbacks";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.ActiveTabName = "Feedback";

    var uaeTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Arabian Standard Time");
}

<div class="content px-1">
    <div class="card shadow rounded-3">
        <div class="card-header bg-primary text-white rounded-top-3 d-flex flex-wrap justify-content-between align-items-center">
            <h4 class="mb-0">All Feedbacks</h4>

            <form method="get" asp-action="Index" class="row gx-2 gy-1 align-items-end m-0">
                <!-- Date Filter -->
                <div class="col-auto">
                    <label for="dateFilter" class="form-label text-white mb-0">Filter</label>
                    <select name="dateFilter" id="dateFilter" class="form-select form-select-sm"
                            asp-items="ViewBag.DateFilterOptions">
                        <option value="">All</option>
                    </select>
                </div>

                <!-- Category Filter -->
                <div class="col-auto">
                    <label for="categoryFilter" class="form-label text-white mb-0">Category</label>
                    <select name="category" id="categoryFilter" class="form-select form-select-sm"
                            asp-items="ViewBag.CategoryOptions">
                        <option value="">-- All Categories --</option>
                    </select>
                </div>

                <div class="col-auto">
                    <button type="submit" class="btn btn-light btn-sm mt-3">
                        <i class="bi bi-filter me-1"></i> Apply
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive p-2">
            <table class="table table-hover table-striped table-bordered align-middle mb-0" id="tblFeedback">
                <thead class="table-light text-center">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Category</th>
                        <th>Message</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in Model)
                    {
                        var uaeDate = TimeZoneInfo.ConvertTimeFromUtc(f.CreatedDate, uaeTimeZone);
                        <tr>
                            <td class="text-center"></td> <!-- DataTables will auto-number -->
                            <td>@f.Name</td>
                            <td>@f.Email</td>
                            <td>@f.Category</td>
                            <td>@f.Message</td>
                            <td data-order="@uaeDate.ToString("yyyyMMddHHmmss")">
                                @uaeDate.ToString("dd MMM yyyy, HH:mm")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
            var table = $('#tblFeedback').DataTable({
                "pageLength": 10,
                "ordering": true,
                "order": [[5, "desc"]],
                "columnDefs": [
                    { "type": "num", "targets": 5 },
                    { "orderable": false, "targets": 0 } // index column non-sortable
                ],
                "language": { "search": "🔍 Search feedbacks:" },
                "drawCallback": function (settings) {
                    var api = this.api();
                    api.column(0, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                        cell.innerHTML = i + 1;
                    });
                }
            });

            $('#categoryFilter').on('change', function () {
                table.column(3).search(this.value).draw();
            });

            $('#dateFilter').on('change', function () {
                table.column(5).search(this.value).draw();
            });
        });
    </script>
}
